var AuctionHelper={logToConsole:false,actionHistory:[],BiddingHistory:[],ExistingBids:[],ElBody:$('body'),ElAuctionDetailPageWrapper:$('.lot-detail'),ElRobotInput:$('.robot-input'),ElRobotButton:$('.switch-robot'),ElBidButton:'.place-bid:not(.expired)',ElHighestBidder:$('.highest-bidder'),ElLotInfoBlock:$('.lot-container'),ElClockWrapper:$('.timer span'),ElHistoryList:function()
{return $('.bidding-history')},ElHistoryRow:function()
{return $('.bidding-history .bid-history')},ElHighestBidderThumb:function(lotID)
{return $('.highest-bidder-thumb.lot-'+lotID)},ElClock:function(lotID)
{return $('.clock.clock-'+lotID)},ElCurrentBid:function(lotID)
{return $('.current-bid.lot-'+lotID);},ElLotContainer:function(lotID)
{return $('.lot-container-'+lotID);},ElRobotCounter:function(robID)
{return $('.unused-robot-credit-'+robID);},ElNumberOfBids:function(lotID)
{return $('.number-of-bids.number-of-bids-'+lotID);},ElBidAmount:function(lotID)
{var bidAmountField=core.screenSize=='xs'?'.bid-amount-mobile':'.bid-amount';return $(bidAmountField+'.bid-amount-'+lotID);},LayClockTime:'%H:%M:%S',LayClockTimeThumb:'%H:%M:%S',LayClockTimeRow:'%H:%M:%S',LayClockDay:'<span class="dag">%-D <small>%s</small></span>',LayHistoryRow:function(id,bidDate,username,bid)
{var historyRowHtml='';$.ajax({'url':baseUri+'auctionlot/bidhistoryrowhtml','type':'POST','async':false,'data':{'id':id,'bidDate':bidDate,'username':username,'bid':bid,},'success':function(data)
{historyRowHtml=data.html;}});return historyRowHtml;},SetMonths:{0:'jan',1:'feb',2:'mrt',3:'apr',4:'mei',5:'jun',6:'jul',7:'aug',8:'sep',9:'okt',10:'nov',11:'dec'},SetDyingSecondsTime:180,SetDyingSecondsClass:'dying-seconds',SetProcessLabel:'Checken',SetMaxLengthBidHistory:4,SetBlurTimeout:1000*60*2,NodeOnConnect:function()
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnConnect');if(isLoggedIn==1){socket.emit('subscribe_user_auction',AuctionHelper.ElAuctionDetailPageWrapper.attr('data-id'),userID,userIDHash);}},NodeOnStart:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnStart');if(AuctionHelper.logToConsole==true){console.log('-- Start --');console.log(data);console.log('-----------');}
location.reload();},NodeOnSubscribe:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnSubscribe');if(AuctionHelper.logToConsole==true){console.log('-- Subscribe --');console.log(data);console.log('---------------');}
if(data.lot.hasExpired==1){AuctionHelper.UpdateExpiredLot(data.lot.id,data.lot.highest_bid_user_id_hash);}
var bids=AuctionHelper.ElNumberOfBids(data.lot.id);if(bids.length){bids.html(data.lot.number_of_bids);}
var dates={serverTime:data.lot.dates.serverTime,endDate:data.lot.dates.endDate};AuctionHelper.SetClock(dates,data.lot.id);if(data.history.length==0){if(data.lot.highestBid<data.lot.startPrice){data.lot.highestBid=data.lot.startPrice;}
AuctionHelper.UpdatePrice(data.lot.id,data.lot.highestBid,null,data.lot.highest_bid_user_id,data.lot.username,null);}
else{data.history.reverse();for(var i=0;i<data.history.length;i++){var history=data.history[i];history.date=Helper.unixToDateTime(history.date);if(data.lot.has_anonymous_bids==1){history.usrUsername=history.random;}
AuctionHelper.UpdatePrice(history.lotID,history.bid,history.date,history.usrID,history.usrUsername,history.bidID);}}},NodeOnReSubscribe:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnReSubscribe');if(AuctionHelper.logToConsole==true){console.log('-- Re Subscribe --');console.log(data);console.log('---------------');}
if(data.hasExpired==1){AuctionHelper.UpdateExpiredLot(data.id,data.highest_bid_user_id);}
else{AuctionHelper.SetClock(data.dates,data.id);}
var price=data.startPrice;if(data.highestBid!=null){price=data.highestBid;}
AuctionHelper.UpdatePrice(data.id,price,null,null,data.username,null);},NodeOnUpdateTimer:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnUpdateTimer');if(AuctionHelper.logToConsole==true){console.log('-- Timer update --');console.log(data.dates);console.log(data.id);console.log('------------------');}
AuctionHelper.SetClock(data.dates,data.id);},NodeOnNewBid:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnNewBid');if(AuctionHelper.logToConsole==true){console.log('-- Bid --');console.log(data);console.log('---------');}
var bids=AuctionHelper.ElNumberOfBids(data.auction_lot_id);if(bids.length){bids.html(data.number_of_bids);}
var dates={serverTime:data.serverTime,endDate:data.end_date};AuctionHelper.SetClock(dates,data.auction_lot_id);AuctionHelper.UpdatePrice(data.auction_lot_id,data.bid,data.bid_date,data.user_id,data.username,data.bid_id);},NodeOnCloseLot:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnCloseLot');if(AuctionHelper.logToConsole==true){console.log('-- Close --');console.log(data);console.log('-----------');}
AuctionHelper.UpdateExpiredLot(data.id,data.highest_bid_user_id);},UpdateExpiredLot:function(lotID,winnerUserHash)
{AuctionHelper.actionHistory.push('AuctionsHelper UpdateExpiredLot');var lot=AuctionHelper.ElLotContainer(lotID);lot.removeClass(AuctionHelper.SetDyingSecondsClass);if(lot.hasClass('thumb')){lot.find('.status').html('Gesloten');var newLink=AuctionHelper.ConvertUrlToClosed(lotID,lot.find('a').attr('href'));lot.find('a').attr('href',newLink);}
else if(lot.hasClass('row-view')){location.reload();}
else{var newLink=AuctionHelper.ConvertUrlToClosed(lotID,window.location.href);window.location=newLink;}},ConvertUrlToClosed:function(lotID,link)
{AuctionHelper.actionHistory.push('AuctionsHelper ConvertUrlToClosed');var check=link.indexOf('/gesloten/');if(check<1){link=link.replace('/veiling/','/gesloten/');link=link+'-'+lotID;}
return link;},NodeOnCloseShop:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnCloseShop');if(AuctionHelper.logToConsole==true){console.log('-- Close shop --');console.log(data);console.log('----------------');}
location.reload();},NodeOnRobotBid:function(data)
{AuctionHelper.actionHistory.push('AuctionsHelper NodeOnRobotBid');if(AuctionHelper.logToConsole==true){console.log('-- Robot bid --');console.log(data);console.log('----------------');}
AuctionHelper.ElRobotInput.val(data.unused);AuctionHelper.ElRobotCounter(data.robotID).html(data.unused);if(data.unused=='0'){AuctionHelper.ElRobotButton.html('Aan');AuctionHelper.ElRobotInput.prop('disabled',false);}},NodeOnDelete:function(data){AuctionHelper.actionHistory.push('AuctionsHelper NodeOnDelete');$('.bidding-history').empty();AuctionHelper.ExistingBids=[];AuctionHelper.BiddingHistory=[];AuctionHelper.NodeOnSubscribe(data);},Init:function()
{AuctionHelper.actionHistory.push('AuctionsHelper Init');$(window).blur(function()
{var blurTimeOut=setTimeout(function()
{if(AuctionHelper.logToConsole==true){console.log('-- Bedankt, daag --');}
AuctionHelper.UnSubscribe();},AuctionHelper.SetBlurTimeout);$(window).one('focus',function()
{if(AuctionHelper.logToConsole==true){console.log('-- Welcome back! --');}
clearTimeout(blurTimeOut);AuctionHelper.ReJoin();});});$(AuctionHelper.ElBidButton).click(function()
{if(isLoggedIn==1){AuctionHelper.PlaceBid();}else{$('#confirm-bid').modal('hide');Helper.mustBeLoggedIn();}
return false;});var elHistoryRow=AuctionHelper.ElHistoryRow();elHistoryRow.each(function()
{var biddingID=$(this).attr('id').substr(4);AuctionHelper.BiddingHistory.push({biddingID:biddingID,html:$(this).clone()});AuctionHelper.ExistingBids[biddingID]=1;});},UnSubscribe:function()
{AuctionHelper.actionHistory.push('AuctionsHelper UnSubscribe');$(AuctionHelper.ElLotInfoBlock).each(function()
{socket.emit('un_subscribe_lot',$(this).attr('id').substr(4));$(this).fadeTo("fast",0.2);$(this).find(AuctionHelper.ElClockWrapper).fadeTo("fast",0);});},ReJoin:function()
{AuctionHelper.actionHistory.push('AuctionsHelper ReJoin');$(AuctionHelper.ElLotInfoBlock).each(function()
{if($(this).attr('data-expired')==0){if($(this).hasClass('lot-detail')){socket.emit('re_subscribe_lot',$(this).attr('data-id'));}else{socket.emit('re_subscribe_lot_thumb',$(this).attr('data-id'));}}
$(this).fadeTo("fast",1);$(this).find(AuctionHelper.ElClockWrapper).fadeTo("fast",1);});},bidTimeOut:0,UpdatePrice:function(lotID,bid,bidDate,userID,username,bidID)
{AuctionHelper.actionHistory.push('AuctionsHelper UpdatePrice');var animationTime=200;var currentBid=AuctionHelper.ElCurrentBid(lotID);if(username==null){username='';}
if(currentBid.hasClass('main')){var fontSize=48;if(core.screenSize=='xs'||core.screenSize=='sm'){var fontSize=19;}
if(bidID>0){AuctionHelper.AddBidder(bidID,bidDate,username,bid);}
else{if(username){AuctionHelper.ElHighestBidder.html(username);}else{AuctionHelper.ElHighestBidder.html('-');}}}
else if(currentBid.hasClass('featured')){var fontSize=14;}
else{var fontSize=16;var usernameElement=AuctionHelper.ElHighestBidderThumb(lotID);if(username){usernameElement.html(username);}else{bid=0;usernameElement.html('-');}}
currentBid.css({'font-size':'5px'});currentBid.html('â‚¬ '+number_format(bid,0,',','.'));currentBid.attr('data-amount',bid);currentBid.clearQueue();currentBid.animate({fontSize:fontSize+"px"},animationTime);if(currentBid.hasClass('row-view')==false){setTimeout(function()
{currentBid.width('auto');},animationTime*2);}},AddBidder:function(id,date,username,bid)
{AuctionHelper.actionHistory.push('AuctionsHelper AddBidder');if(AuctionHelper.ExistingBids[id]===1){return;}
AuctionHelper.ExistingBids[id]=1;var elHistoryList=AuctionHelper.ElHistoryList();var elHistoryRow=AuctionHelper.ElHistoryRow();elHistoryRow.remove();date=date.replace(/-/g,'/');var time=new Date(date);var addZeros=('0'+time.getHours()).slice(-2)+':'+('0'+time.getMinutes()).slice(-2);var year=time.getFullYear().toString().substr(2);var bidDate=addZeros+' op '+('0'+time.getDate()).slice(-2)+' '+AuctionHelper.SetMonths[parseInt(time.getMonth().toString())];console.log(bidDate);var newBidHtml=AuctionHelper.LayHistoryRow(id,bidDate,username,number_format(bid,0,',','.'));AuctionHelper.BiddingHistory.unshift({id:id,username:username,html:newBidHtml});while(AuctionHelper.BiddingHistory.length>AuctionHelper.SetMaxLengthBidHistory){AuctionHelper.BiddingHistory.pop();}
AuctionHelper.BiddingHistory.sort(function(a,b)
{return b.id-a.id});for(var i=0;i<AuctionHelper.BiddingHistory.length;i++){if(i==0){AuctionHelper.ElHighestBidder.html(AuctionHelper.BiddingHistory[i].username);}
elHistoryList.append(AuctionHelper.BiddingHistory[i].html);}},SetClock:function(dates,id)
{AuctionHelper.actionHistory.push('AuctionsHelper SetClock');if(AuctionHelper.logToConsole==true){console.log('-- Clock --');console.log(dates);console.log(id);console.log('-----------');}
var clock=AuctionHelper.ElClock(id);var container=AuctionHelper.ElLotContainer(id);var clientTime=new Date().getTime();var endDate=dates.endDate;var serverTime=dates.serverTime;var newTimestamp=parseInt(endDate)+(parseInt(clientTime)-parseInt(serverTime));var timer=Helper.unixToDateTime(newTimestamp);clock.attr('data-timestamp',newTimestamp);clock.attr('data-time',timer);clock.countdown(timer,{elapse:true}).on('update.countdown',function(event)
{if(event.elapsed){container.removeClass(AuctionHelper.SetDyingSecondsClass);container.find('div.product').removeClass(AuctionHelper.SetDyingSecondsClass);$(this).html(AuctionHelper.SetProcessLabel);}
else{if(parseInt(event.strftime('%D%H%M%S'))<=AuctionHelper.SetDyingSecondsTime){container.addClass(AuctionHelper.SetDyingSecondsClass);if(container.hasClass('thumb')){container.find('a').addClass('btn-primary');container.find('a').removeClass('btn-success');}}else{container.removeClass(AuctionHelper.SetDyingSecondsClass);if(container.hasClass('thumb')){container.find('a').removeClass('btn-primary');container.find('a').addClass('btn-success');}}
if(AuctionHelper.ElLotContainer(id).hasClass('row-view')){var format=AuctionHelper.LayClockTimeRow;}else if(AuctionHelper.ElLotContainer(id).hasClass('thumb')){var format=AuctionHelper.LayClockTimeThumb;}else{var format=AuctionHelper.LayClockTime;}
if(event.offset.totalDays>0&&AuctionHelper.ElLotContainer(id).hasClass('row-view')==false){format=AuctionHelper.LayClockDay+' '+format;format=format.replace(/%s/g,event.strftime('%-D')>1?'dagen':'dag');}
$(this).html(event.strftime(format));}});},PlaceBid:function()
{AuctionHelper.actionHistory.push('AuctionsHelper PlaceBid');var form=$('#bid-popup-form'),auctionLotID=form.attr('data-id'),formData=new FormData(document.querySelector('#bid-popup-form'));$.ajax({xhr:function()
{var xhr=new window.XMLHttpRequest();xhr.upload.addEventListener('progress',function(evt){if(evt.lengthComputable){var percentComplete=(evt.loaded/evt.total)*100;}},false);return xhr;},url:form.attr('action'),method:'POST',async:true,contentType:false,processData:false,data:formData}).complete(function(xhr)
{var data=jQuery.parseJSON(xhr.responseText);if(typeof data.status!=='undefined'){var messages='';$.each(data.messages,function(index,value)
{messages=messages+'<div class="alert alert-danger" style="margin-bottom:5px;" role="alert">'+value+'</div>';});Helper.alert('Bieden mislukt',messages);}else{var title='';var message='';var button='';if(data==0){title='Gelukt';message='<div class="alert alert-success" role="alert">Het bod is geplaatst</div>';$('#confirm-bid').modal('hide');}else if(data==1){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Bieden op onze website is enkel mogelijk tussen 08.00 uur en 20.00 uur.<br><br>De lopende veilingen gaan vanaf 08.00 uur weer verder. Een gedaan bod blijft uiteraard voor u behouden.</div>';}else if(data==2){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Kavel niet gevonden</div>';}else if(data==3){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Dit kavel is gesloten</div>';}else if(data==4){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Je bent al de hoogste bieder</div>';}else if(data==5){var currentBid=parseFloat(AuctionHelper.ElCurrentBid(auctionLotID).attr('data-amount'));var minimumBid=Helper.getIncrementPrice(currentBid);title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Bod is niet voldoende, het minimale volgende bod is &euro; '+number_format(currentBid+minimumBid,0,',','.')+'</div>';}else if(data==6){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Er is iets mis gegaan, neem a.u.b. contact met ons op</div>';}else if(data==7){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Log in om mee te bieden</div>';}else if(data==8){title='Bieden mislukt';message='Onvoldoende credits voor dit bod';button={action:function()
{window.location=baseUri+'dashboard/credits';},label:'Biedpunten kopen'};}else if(data==9){title='Bieden mislukt';message='Je kan alleen meebieden bij een beginnersveiling als je nog nooit een veiling gewonnen hebt';}else if(data==10){title='Bieden mislukt';message='Dit is een royalty veiling, alleen royalty members kunnen meebieden';}else if(data==11){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Er kan niet geboden worden tijdens het controleren van een veiling</div>';}else if(data==12){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Je hebt al het maximaal aantal veilingen gewonnen per week</div>';}else if(data==13){title='Bieden mislukt';message='Je hebt deze veiling al direct gekocht';}else if(data==14){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Het maximaal bod voor deze veiling is bereikt</div>';}else if(data==15){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Uw account is niet geschikt voor bieden</div>';}else if(data==16){$('#complete-profile-modal').modal('show');return true;}else if(data==17){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Het bod is niet boven de vraagprijs</div>';}else if(data==18){var currentBid=parseInt($('.current-bid.main').data('amount')),maxBid=currentBid+(Helper.getIncrementPrice(currentBid)*5);title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Het bod is te hoog, bied maximaal: &euro;'+number_format(maxBid,0,',','.')+'</div>';}else if(data==19){title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Bieden is nog niet toegestaan</div>';}else if(data==20){title=translated_bidding_failed;message=translated_your_account_is_not+' <a href="'+baseUri+'cm/idin/idin?lot='+auctionLotID+'" title="'+translated_start_verification+'">'+translated_verified+'.';button={action:function()
{window.location=baseUri+'cm/idin/idin?lot='+auctionLotID;},label:translated_start_verification};}else if(typeof data.code!=='undefined'&&typeof data.maxBid!=='undefined'&&data.code==21){var maxBid=data.maxBid;title='Bieden mislukt';message='<div class="alert alert-warning" role="alert">Het bod is te hoog, bied maximaal: &euro;'+number_format(maxBid,0,',','.')+'</div>';}
if(button!=''){Helper.customAlert(title,message,false,'Sluiten',false,button.action,button.label,true);}
else{Helper.alert(title,message);}}});}};socket.on('connect',AuctionHelper.NodeOnConnect);socket.on('subscribe',AuctionHelper.NodeOnSubscribe);socket.on('re_subscribe',AuctionHelper.NodeOnReSubscribe);socket.on('start',AuctionHelper.NodeOnStart);socket.on('new_bid',AuctionHelper.NodeOnNewBid);socket.on('update_timer',AuctionHelper.NodeOnUpdateTimer);socket.on('close_lot',AuctionHelper.NodeOnCloseLot);socket.on('close_shop',AuctionHelper.NodeOnCloseShop);socket.on('push_robot_credits',AuctionHelper.NodeOnRobotBid);socket.on('ondelete',AuctionHelper.NodeOnDelete);